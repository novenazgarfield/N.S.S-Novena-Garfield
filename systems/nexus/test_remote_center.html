<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUSè¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒ - æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 3em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin: 10px 0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-5px);
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }
        .status-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .websocket-test {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .websocket-test h2 {
            margin-top: 0;
            text-align: center;
        }
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }
        .status-indicator.connected {
            background: #44ff44;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .command-btn {
            background: linear-gradient(45deg, #FF6B6B 30%, #4ECDC4 90%);
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .command-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .command-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .log-container {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #00ff00;
        }
        .log-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        .log-timestamp {
            color: #888;
            font-size: 0.8em;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ NEXUS è¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒ</h1>
            <p>å¤šè®¾å¤‡ååŒ Â· è¿œç¨‹å‘½ä»¤æ‰§è¡Œ Â· å®æ—¶ç›‘æ§</p>
            <p>æµ‹è¯•é¡µé¢ - éªŒè¯WebSocketè¿æ¥å’Œè¿œç¨‹å‘½ä»¤åŠŸèƒ½</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸŒ è¿æ¥çŠ¶æ€</h3>
                <div class="value" id="connectionStatus">æ–­å¼€</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“¡ æ´»åŠ¨ä»»åŠ¡</h3>
                <div class="value" id="activeTasks">0</div>
            </div>
            <div class="status-card">
                <h3>ğŸ”§ å¯ç”¨å‘½ä»¤</h3>
                <div class="value" id="availableCommands">0</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“Š è¿æ¥è®¾å¤‡</h3>
                <div class="value" id="connectedDevices">0</div>
            </div>
        </div>

        <div class="websocket-test">
            <h2>WebSocket è¿æ¥æµ‹è¯•</h2>
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">æ­£åœ¨è¿æ¥...</span>
            </div>
            
            <div class="command-buttons">
                <button class="command-btn" onclick="showWakeDialog()" disabled id="wakeBtn" style="background: linear-gradient(45deg, #4CAF50 30%, #8BC34A 90%);">
                    ğŸŒ… è¿œç¨‹å”¤é†’ç”µè„‘
                </button>
                <button class="command-btn" onclick="showShutdownDialog()" disabled id="shutdownBtn" style="background: linear-gradient(45deg, #f44336 30%, #ff5722 90%);">
                    ğŸ”´ è¿œç¨‹å…³æœº/é‡å¯
                </button>
                <button class="command-btn" onclick="executeCommand('genome_jigsaw')" disabled id="genomeBtn">
                    ğŸ§¬ åŸºå› ç»„æ˜Ÿäº‘åˆ†æ
                </button>
                <button class="command-btn" onclick="executeCommand('gromacs_simulation')" disabled id="gromacsBtn">
                    âš›ï¸ GROMACSæ¨¡æ‹Ÿ
                </button>
                <button class="command-btn" onclick="executeCommand('protein_folding')" disabled id="proteinBtn">
                    ğŸ§ª è›‹ç™½è´¨æŠ˜å é¢„æµ‹
                </button>
                <button class="command-btn" onclick="executeCommand('system_status')" disabled id="statusBtn">
                    ğŸ–¥ï¸ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
                </button>
            </div>

            <h3>å®æ—¶æ—¥å¿—</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-timestamp">[ç­‰å¾…è¿æ¥]</span> 
                    æ­£åœ¨è¿æ¥åˆ°NEXUSè¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒ...
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ‰ NEXUSè¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒå·²å‡çº§å®Œæˆï¼</p>
            <p>ç°åœ¨æ‚¨å¯ä»¥åœ¨ä»»ä½•è®¾å¤‡ä¸Šè¿œç¨‹æ§åˆ¶å’Œç›‘æ§æ‚¨çš„NEXUSç³»ç»Ÿ</p>
        </div>
    </div>

    <script>
        let ws = null;
        let activeTasks = new Set();
        let availableCommands = {};

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let color = '#00ff00';
            if (type === 'error') color = '#ff4444';
            if (type === 'warning') color = '#ffaa00';
            if (type === 'success') color = '#44ff44';
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span> 
                <span style="color: ${color}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectionStatus = document.getElementById('connectionStatus');
            const buttons = document.querySelectorAll('.command-btn');

            if (connected) {
                indicator.classList.add('connected');
                statusText.textContent = 'å·²è¿æ¥åˆ°è¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒ';
                connectionStatus.textContent = 'å·²è¿æ¥';
                buttons.forEach(btn => btn.disabled = false);
                addLog('âœ… æˆåŠŸè¿æ¥åˆ°NEXUSè¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒï¼', 'success');
            } else {
                indicator.classList.remove('connected');
                statusText.textContent = 'è¿æ¥æ–­å¼€';
                connectionStatus.textContent = 'æ–­å¼€';
                buttons.forEach(btn => btn.disabled = true);
                addLog('âŒ ä¸è¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒçš„è¿æ¥å·²æ–­å¼€', 'error');
            }
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = function(event) {
                    updateConnectionStatus(true);
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        addLog('æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯: ' + event.data, 'warning');
                    }
                };

                ws.onclose = function(event) {
                    updateConnectionStatus(false);
                    // 5ç§’åå°è¯•é‡è¿
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = function(error) {
                    addLog('WebSocketé”™è¯¯: ' + error, 'error');
                };

            } catch (error) {
                addLog('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                setTimeout(connectWebSocket, 5000);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'welcome':
                    addLog('ğŸ‰ ' + data.message, 'success');
                    availableCommands = data.available_commands || {};
                    document.getElementById('availableCommands').textContent = Object.keys(availableCommands).length;
                    break;

                case 'task_started':
                    activeTasks.add(data.task_id);
                    document.getElementById('activeTasks').textContent = activeTasks.size;
                    addLog(`ğŸš€ ä»»åŠ¡å·²å¯åŠ¨: ${data.description} (ID: ${data.task_id.substring(0, 8)}...)`, 'info');
                    break;

                case 'task_log':
                    addLog(`[${data.task_id.substring(0, 8)}...] ${data.output}`, 'info');
                    break;

                case 'task_completed':
                    activeTasks.delete(data.task_id);
                    document.getElementById('activeTasks').textContent = activeTasks.size;
                    const status = data.status === 'completed' ? 'âœ…' : 'âŒ';
                    addLog(`${status} ä»»åŠ¡${data.status}: ${data.task_id.substring(0, 8)}...`, 
                           data.status === 'completed' ? 'success' : 'error');
                    break;

                case 'task_error':
                    activeTasks.delete(data.task_id);
                    document.getElementById('activeTasks').textContent = activeTasks.size;
                    addLog(`âŒ ä»»åŠ¡é”™è¯¯: ${data.error}`, 'error');
                    break;

                case 'system_info':
                    document.getElementById('connectedDevices').textContent = data.connected_clients;
                    document.getElementById('activeTasks').textContent = data.active_tasks;
                    addLog(`ğŸ“Š ç³»ç»Ÿä¿¡æ¯æ›´æ–°: ${data.connected_clients}ä¸ªè®¾å¤‡è¿æ¥, ${data.active_tasks}ä¸ªæ´»åŠ¨ä»»åŠ¡`, 'info');
                    break;

                case 'task_created':
                    addLog(`âœ… å‘½ä»¤å·²æäº¤: ${data.message}`, 'success');
                    break;

                case 'error':
                    addLog(`âŒ é”™è¯¯: ${data.message}`, 'error');
                    break;

                default:
                    addLog(`æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info');
            }
        }

        function executeCommand(command, parameters = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•æ‰§è¡Œå‘½ä»¤', 'error');
                return;
            }

            const message = {
                type: 'execute_command',
                command: command,
                parameters: parameters
            };

            ws.send(JSON.stringify(message));
            addLog(`ğŸ“¤ å‘é€å‘½ä»¤: ${command}`, 'info');
        }

        function showWakeDialog() {
            const macAddress = prompt('è¯·è¾“å…¥ç›®æ ‡ç”µè„‘çš„MACåœ°å€ (æ ¼å¼: XX:XX:XX:XX:XX:XX):');
            if (!macAddress) return;

            const macPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            if (!macPattern.test(macAddress)) {
                alert('MACåœ°å€æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨æ ¼å¼ï¼šXX:XX:XX:XX:XX:XX');
                return;
            }

            const ipAddress = prompt('è¯·è¾“å…¥å¹¿æ’­IPåœ°å€ (é»˜è®¤: 192.168.1.255):', '192.168.1.255');
            if (!ipAddress) return;

            addLog(`ğŸŒ… å‡†å¤‡å”¤é†’ç”µè„‘ MAC: ${macAddress}`, 'info');
            executeCommand('wake_computer', {
                mac_address: macAddress,
                ip_address: ipAddress
            });
        }

        function showShutdownDialog() {
            const shutdownType = prompt('è¯·é€‰æ‹©æ“ä½œç±»å‹:\n1. normal - æ­£å¸¸å…³æœº\n2. force - å¼ºåˆ¶å…³æœº\n3. reboot - é‡å¯ç”µè„‘\n\nè¯·è¾“å…¥ (normal/force/reboot):', 'normal');
            if (!shutdownType || !['normal', 'force', 'reboot'].includes(shutdownType)) {
                alert('æ— æ•ˆçš„æ“ä½œç±»å‹ï¼');
                return;
            }

            const delaySeconds = prompt('è¯·è¾“å…¥å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼Œå»ºè®®è‡³å°‘60ç§’ï¼‰:', '60');
            if (!delaySeconds || isNaN(delaySeconds) || parseInt(delaySeconds) < 10) {
                alert('å»¶è¿Ÿæ—¶é—´æ— æ•ˆï¼è‡³å°‘éœ€è¦10ç§’ã€‚');
                return;
            }

            const message = prompt('è¯·è¾“å…¥å…³æœºæ¶ˆæ¯:', 'NEXUSè¿œç¨‹å…³æœº - è¯·ä¿å­˜æ‚¨çš„å·¥ä½œ');
            if (!message) return;

            const actionText = shutdownType === 'reboot' ? 'é‡å¯' : 'å…³æœº';
            const confirmText = `ç¡®è®¤è¦${actionText}æœ¬åœ°ç”µè„‘å—ï¼Ÿ\n\nç±»å‹: ${shutdownType}\nå»¶è¿Ÿ: ${delaySeconds}ç§’\næ¶ˆæ¯: ${message}`;
            
            if (!confirm(confirmText)) return;

            addLog(`ğŸ”´ å‡†å¤‡${actionText}ç”µè„‘ï¼Œå»¶è¿Ÿ${delaySeconds}ç§’`, 'warning');
            executeCommand('shutdown_computer', {
                shutdown_type: shutdownType,
                delay_seconds: parseInt(delaySeconds),
                message: message
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = function() {
            addLog('ğŸ”„ æ­£åœ¨åˆå§‹åŒ–NEXUSè¿œç¨‹æŒ‡æŒ¥ä¸­å¿ƒ...', 'info');
            connectWebSocket();
        };
    </script>
</body>
</html>