<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å­æ¨¡æ‹Ÿ - ç¬¬ä¸€é¢—3DåŸå­</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: white;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 100;
        }

        #info-panel h2 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            font-size: 1.5em;
        }

        #info-panel p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .control-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        #atom-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            min-width: 200px;
            z-index: 100;
        }

        .atom-count {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .atom-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        .atom-item {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-container"></div>
        
        <div id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½åˆ†å­æ•°æ®...</p>
        </div>

        <div id="info-panel">
            <h2>ğŸ§¬ åˆ†å­æ¨¡æ‹Ÿ</h2>
            <p><strong>ç›®æ ‡:</strong> ç¬¬ä¸€é¢—3DåŸå­</p>
            <p><strong>æŠ€æœ¯:</strong> Three.js + PDBLoader</p>
            <p><strong>æ•°æ®æº:</strong> å’–å•¡å› åˆ†å­ (CFF)</p>
            <p><strong>æ“ä½œ:</strong></p>
            <ul style="font-size: 12px; margin: 10px 0; padding-left: 20px;">
                <li>é¼ æ ‡æ‹–æ‹½: æ—‹è½¬è§†è§’</li>
                <li>æ»šè½®: ç¼©æ”¾</li>
                <li>å³é”®æ‹–æ‹½: å¹³ç§»</li>
            </ul>
        </div>

        <div id="atom-info">
            <div class="atom-count">åŸå­æ•°é‡: 0</div>
            <div class="atom-list" id="atom-list"></div>
        </div>

        <div id="controls">
            <button class="control-button" onclick="resetCamera()">ğŸ¯ é‡ç½®è§†è§’</button>
            <button class="control-button" onclick="toggleWireframe()">ğŸ”² çº¿æ¡†æ¨¡å¼</button>
            <button class="control-button" onclick="toggleLabels()">ğŸ·ï¸ æ˜¾ç¤ºæ ‡ç­¾</button>
        </div>
    </div>

    <!-- Three.js æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/three.min.js"></script>
    
    <!-- PDBåŠ è½½å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/PDBLoader.js"></script>
    
    <!-- è½¨é“æ§åˆ¶å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let atomGroup, labelGroup;
        let atoms = [];
        let wireframeMode = false;
        let labelsVisible = false;

        // åŸå­é¢œè‰²æ˜ å°„ (CPKé¢œè‰²æ–¹æ¡ˆ)
        const atomColors = {
            'H': 0xFFFFFF,  // æ°¢ - ç™½è‰²
            'C': 0x909090,  // ç¢³ - ç°è‰²
            'N': 0x3050F8,  // æ°® - è“è‰²
            'O': 0xFF0D0D,  // æ°§ - çº¢è‰²
            'F': 0x90E050,  // æ°Ÿ - ç»¿è‰²
            'P': 0xFF8000,  // ç£· - æ©™è‰²
            'S': 0xFFFF30,  // ç¡« - é»„è‰²
            'CL': 0x1FF01F, // æ°¯ - ç»¿è‰²
            'BR': 0xA62929, // æº´ - æ£•è‰²
            'I': 0x940094,  // ç¢˜ - ç´«è‰²
            'default': 0xFF1493 // é»˜è®¤ - æ·±ç²‰è‰²
        };

        // åŸå­åŠå¾„æ˜ å°„ (èŒƒå¾·ååŠå¾„ï¼Œå•ä½ï¼šåŸƒ)
        const atomRadii = {
            'H': 0.3,
            'C': 0.4,
            'N': 0.35,
            'O': 0.32,
            'F': 0.3,
            'P': 0.5,
            'S': 0.45,
            'CL': 0.45,
            'BR': 0.5,
            'I': 0.55,
            'default': 0.4
        };

        // åˆå§‹åŒ–åœºæ™¯
        function initScene() {
            console.log('ğŸš€ åˆå§‹åŒ–åˆ†å­æ¨¡æ‹Ÿåœºæ™¯...');

            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);

            // åˆ›å»ºæ‘„åƒæœº
            camera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.set(10, 10, 10);

            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // åˆ›å»ºè½¨é“æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.enablePan = true;

            // æ·»åŠ ç¯å…‰
            setupLighting();

            // åˆ›å»ºåŸå­å’Œæ ‡ç­¾ç»„
            atomGroup = new THREE.Group();
            labelGroup = new THREE.Group();
            scene.add(atomGroup);
            scene.add(labelGroup);

            console.log('âœ… åœºæ™¯åˆå§‹åŒ–å®Œæˆ');
        }

        // è®¾ç½®ç¯å…‰
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            // æ–¹å‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // ç‚¹å…‰æº
            const pointLight = new THREE.PointLight(0x4CAF50, 0.5, 50);
            pointLight.position.set(-10, -10, -10);
            scene.add(pointLight);

            // å¦ä¸€ä¸ªç‚¹å…‰æº
            const pointLight2 = new THREE.PointLight(0xFF6B6B, 0.3, 30);
            pointLight2.position.set(5, -5, 10);
            scene.add(pointLight2);
        }

        // åŠ è½½PDBæ–‡ä»¶
        function loadPDBFile() {
            console.log('ğŸ“ å¼€å§‹åŠ è½½PDBæ–‡ä»¶...');

            const loader = new THREE.PDBLoader();
            
            // å’–å•¡å› åˆ†å­çš„PDBæ–‡ä»¶URL
            const pdbUrl = 'https://files.rcsb.org/ligands/view/CFF_ideal.pdb';
            
            loader.load(
                pdbUrl,
                // åŠ è½½æˆåŠŸå›è°ƒ
                function(pdb) {
                    console.log('âœ… PDBæ–‡ä»¶åŠ è½½æˆåŠŸ:', pdb);
                    processPDBData(pdb);
                    hideLoading();
                },
                // åŠ è½½è¿›åº¦å›è°ƒ
                function(progress) {
                    console.log('ğŸ“Š åŠ è½½è¿›åº¦:', (progress.loaded / progress.total * 100).toFixed(1) + '%');
                },
                // åŠ è½½é”™è¯¯å›è°ƒ
                function(error) {
                    console.error('âŒ PDBæ–‡ä»¶åŠ è½½å¤±è´¥:', error);
                    
                    // å¦‚æœç½‘ç»œåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨çš„æ¨¡æ‹Ÿæ•°æ®
                    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æ¨¡æ‹Ÿæ•°æ®...');
                    createMockMolecule();
                    hideLoading();
                }
            );
        }

        // å¤„ç†PDBæ•°æ®
        function processPDBData(pdb) {
            console.log('ğŸ§¬ å¤„ç†PDBæ•°æ®...');
            
            atoms = [];
            const atomData = pdb.atoms;
            
            console.log(`ğŸ“Š å‘ç° ${atomData.length} ä¸ªåŸå­`);

            // éå†æ‰€æœ‰åŸå­
            atomData.forEach((atom, index) => {
                const element = atom.element.toUpperCase();
                const position = new THREE.Vector3(atom.x, atom.y, atom.z);
                
                // åˆ›å»ºåŸå­çƒä½“
                createAtom(element, position, index);
                
                // ä¿å­˜åŸå­ä¿¡æ¯
                atoms.push({
                    element: element,
                    position: position,
                    index: index,
                    x: atom.x,
                    y: atom.y,
                    z: atom.z
                });
            });

            // æ›´æ–°åŸå­ä¿¡æ¯æ˜¾ç¤º
            updateAtomInfo();
            
            // è°ƒæ•´æ‘„åƒæœºä½ç½®ä»¥é€‚åº”åˆ†å­å¤§å°
            fitCameraToMolecule();
            
            console.log('âœ… åŸå­æ¸²æŸ“å®Œæˆ');
        }

        // åˆ›å»ºå•ä¸ªåŸå­
        function createAtom(element, position, index) {
            // è·å–åŸå­é¢œè‰²å’ŒåŠå¾„
            const color = atomColors[element] || atomColors.default;
            const radius = (atomRadii[element] || atomRadii.default) * 0.5; // ç¼©æ”¾å› å­

            // åˆ›å»ºçƒä½“å‡ ä½•
            const geometry = new THREE.SphereGeometry(radius, 16, 16);
            
            // åˆ›å»ºæè´¨
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });

            // åˆ›å»ºç½‘æ ¼
            const atomMesh = new THREE.Mesh(geometry, material);
            atomMesh.position.copy(position);
            atomMesh.castShadow = true;
            atomMesh.receiveShadow = true;
            
            // æ·»åŠ ç”¨æˆ·æ•°æ®
            atomMesh.userData = {
                element: element,
                index: index,
                originalMaterial: material
            };

            // æ·»åŠ åˆ°åŸå­ç»„
            atomGroup.add(atomMesh);

            // åˆ›å»ºåŸå­æ ‡ç­¾ (åˆå§‹éšè—)
            createAtomLabel(element, position, index);
        }

        // åˆ›å»ºåŸå­æ ‡ç­¾
        function createAtomLabel(element, position, index) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;

            // ç»˜åˆ¶æ ‡ç­¾
            context.fillStyle = 'rgba(0, 0, 0, 0.8)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.fillStyle = 'white';
            context.font = '16px Arial';
            context.textAlign = 'center';
            context.fillText(element, canvas.width / 2, 25);
            context.fillText(`#${index}`, canvas.width / 2, 45);

            // åˆ›å»ºçº¹ç†å’Œæè´¨
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true,
                opacity: 0
            });

            // åˆ›å»ºç²¾çµ
            const sprite = new THREE.Sprite(material);
            sprite.position.copy(position);
            sprite.position.y += 1; // ç¨å¾®å‘ä¸Šåç§»
            sprite.scale.set(2, 1, 1);

            labelGroup.add(sprite);
        }

        // åˆ›å»ºæ¨¡æ‹Ÿåˆ†å­æ•°æ® (å¤‡ç”¨æ–¹æ¡ˆ)
        function createMockMolecule() {
            console.log('ğŸ”¬ åˆ›å»ºæ¨¡æ‹Ÿå’–å•¡å› åˆ†å­...');
            
            atoms = [];
            
            // æ¨¡æ‹Ÿå’–å•¡å› åˆ†å­çš„åŸå­æ•°æ®
            const mockAtoms = [
                { element: 'C', x: 0, y: 0, z: 0 },
                { element: 'C', x: 1.4, y: 0, z: 0 },
                { element: 'C', x: 2.1, y: 1.2, z: 0 },
                { element: 'N', x: 1.4, y: 2.4, z: 0 },
                { element: 'C', x: 0, y: 2.4, z: 0 },
                { element: 'N', x: -0.7, y: 1.2, z: 0 },
                { element: 'O', x: 3.3, y: 1.2, z: 0 },
                { element: 'H', x: -0.5, y: -0.9, z: 0 },
                { element: 'H', x: 1.9, y: -0.9, z: 0 },
                { element: 'H', x: 1.9, y: 3.3, z: 0 },
                { element: 'H', x: -0.5, y: 3.3, z: 0 },
                { element: 'C', x: -2.1, y: 1.2, z: 0 },
                { element: 'H', x: -2.6, y: 0.3, z: 0 },
                { element: 'H', x: -2.6, y: 2.1, z: 0 },
                { element: 'H', x: -2.1, y: 1.2, z: 0.9 }
            ];

            mockAtoms.forEach((atom, index) => {
                const position = new THREE.Vector3(atom.x, atom.y, atom.z);
                createAtom(atom.element, position, index);
                
                atoms.push({
                    element: atom.element,
                    position: position,
                    index: index,
                    x: atom.x,
                    y: atom.y,
                    z: atom.z
                });
            });

            updateAtomInfo();
            fitCameraToMolecule();
            
            console.log('âœ… æ¨¡æ‹Ÿåˆ†å­åˆ›å»ºå®Œæˆ');
        }

        // æ›´æ–°åŸå­ä¿¡æ¯æ˜¾ç¤º
        function updateAtomInfo() {
            const atomCount = document.querySelector('.atom-count');
            const atomList = document.getElementById('atom-list');
            
            atomCount.textContent = `åŸå­æ•°é‡: ${atoms.length}`;
            
            // ç»Ÿè®¡å„ç§å…ƒç´ 
            const elementCount = {};
            atoms.forEach(atom => {
                elementCount[atom.element] = (elementCount[atom.element] || 0) + 1;
            });
            
            // æ˜¾ç¤ºå…ƒç´ ç»Ÿè®¡
            atomList.innerHTML = '';
            Object.entries(elementCount).forEach(([element, count]) => {
                const div = document.createElement('div');
                div.className = 'atom-item';
                div.innerHTML = `<span style="color: #${atomColors[element].toString(16).padStart(6, '0')}">${element}</span>: ${count}ä¸ª`;
                atomList.appendChild(div);
            });
        }

        // è°ƒæ•´æ‘„åƒæœºä»¥é€‚åº”åˆ†å­
        function fitCameraToMolecule() {
            if (atoms.length === 0) return;

            // è®¡ç®—åˆ†å­çš„è¾¹ç•Œæ¡†
            const box = new THREE.Box3();
            atomGroup.children.forEach(atom => {
                box.expandByObject(atom);
            });

            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);

            // è®¾ç½®æ‘„åƒæœºä½ç½®
            const distance = maxDim * 3;
            camera.position.set(distance, distance, distance);
            camera.lookAt(center);
            
            // è®¾ç½®æ§åˆ¶å™¨ç›®æ ‡
            controls.target.copy(center);
            controls.update();
        }

        // éšè—åŠ è½½ç•Œé¢
        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }

        // é‡ç½®æ‘„åƒæœº
        function resetCamera() {
            fitCameraToMolecule();
        }

        // åˆ‡æ¢çº¿æ¡†æ¨¡å¼
        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            
            atomGroup.children.forEach(atom => {
                atom.material.wireframe = wireframeMode;
            });
            
            console.log(`ğŸ”² çº¿æ¡†æ¨¡å¼: ${wireframeMode ? 'å¼€å¯' : 'å…³é—­'}`);
        }

        // åˆ‡æ¢æ ‡ç­¾æ˜¾ç¤º
        function toggleLabels() {
            labelsVisible = !labelsVisible;
            
            labelGroup.children.forEach(label => {
                label.material.opacity = labelsVisible ? 0.8 : 0;
            });
            
            console.log(`ğŸ·ï¸ æ ‡ç­¾æ˜¾ç¤º: ${labelsVisible ? 'å¼€å¯' : 'å…³é—­'}`);
        }

        // æ¸²æŸ“å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();
            
            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }

        // çª—å£å¤§å°è°ƒæ•´
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // åˆå§‹åŒ–åº”ç”¨
        function init() {
            console.log('ğŸ§¬ åˆ†å­æ¨¡æ‹Ÿç³»ç»Ÿå¯åŠ¨...');
            
            initScene();
            loadPDBFile();
            animate();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('resize', onWindowResize, false);
            
            console.log('âœ… åˆ†å­æ¨¡æ‹Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>