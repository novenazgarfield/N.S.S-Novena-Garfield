<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分子模拟 - 轻量版</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: white;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 100;
        }

        #info-panel h2 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            font-size: 1.5em;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
        }

        .control-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        #atom-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            min-width: 200px;
            z-index: 100;
        }

        .performance-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #FFC107;
            color: #FFC107;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">
            <div class="spinner"></div>
            <p>正在加载轻量版分子模拟...</p>
        </div>

        <div id="info-panel">
            <div class="performance-warning">
                ⚡ 轻量版：优化GPU性能，降低渲染复杂度
            </div>
            <h2>🧬 分子模拟 (轻量版)</h2>
            <p><strong>优化:</strong> 低多边形模型</p>
            <p><strong>性能:</strong> 适合低端GPU</p>
            <p><strong>操作:</strong></p>
            <ul style="font-size: 12px; margin: 10px 0; padding-left: 20px;">
                <li>鼠标拖拽: 旋转视角</li>
                <li>滚轮: 缩放</li>
            </ul>
        </div>

        <div id="atom-info">
            <div style="font-size: 18px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">
                原子数量: <span id="atom-count">0</span>
            </div>
            <div style="font-size: 12px;">
                <div>氢(H): <span id="h-count">0</span></div>
                <div>碳(C): <span id="c-count">0</span></div>
                <div>氮(N): <span id="n-count">0</span></div>
                <div>氧(O): <span id="o-count">0</span></div>
            </div>
        </div>

        <div id="controls">
            <button class="control-button" onclick="resetCamera()">🎯 重置</button>
            <button class="control-button" onclick="toggleWireframe()">🔲 线框</button>
        </div>
    </div>

    <!-- Three.js 核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r158/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let atomGroup;
        let atoms = [];
        let wireframeMode = false;

        // 简化的原子颜色
        const atomColors = {
            'H': 0xFFFFFF,
            'C': 0x909090,
            'N': 0x3050F8,
            'O': 0xFF0D0D,
            'default': 0xFF1493
        };

        // 简化的原子半径
        const atomRadii = {
            'H': 0.3,
            'C': 0.4,
            'N': 0.35,
            'O': 0.32,
            'default': 0.4
        };

        function initScene() {
            console.log('🚀 初始化轻量版分子模拟...');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(10, 10, 10);

            // 使用基础渲染器设置
            renderer = new THREE.WebGLRenderer({ antialias: false }); // 关闭抗锯齿提升性能
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // 限制像素比
            
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = false; // 关闭阻尼提升性能

            // 简化光照
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            atomGroup = new THREE.Group();
            scene.add(atomGroup);

            console.log('✅ 轻量版场景初始化完成');
        }

        function createMockMolecule() {
            console.log('🔬 创建简化咖啡因分子...');
            
            atoms = [];
            
            // 只创建主要原子，减少数量
            const mockAtoms = [
                { element: 'C', x: 0, y: 0, z: 0 },
                { element: 'C', x: 1.4, y: 0, z: 0 },
                { element: 'C', x: 2.1, y: 1.2, z: 0 },
                { element: 'N', x: 1.4, y: 2.4, z: 0 },
                { element: 'C', x: 0, y: 2.4, z: 0 },
                { element: 'N', x: -0.7, y: 1.2, z: 0 },
                { element: 'O', x: 3.3, y: 1.2, z: 0 },
                { element: 'H', x: -0.5, y: -0.9, z: 0 },
                { element: 'H', x: 1.9, y: -0.9, z: 0 },
                { element: 'H', x: 1.9, y: 3.3, z: 0 }
            ];

            // 创建共享几何体以提升性能
            const geometries = {};
            Object.keys(atomRadii).forEach(element => {
                const radius = atomRadii[element] * 0.5;
                // 使用极低多边形数 (4x4 而不是 16x16)
                geometries[element] = new THREE.SphereGeometry(radius, 4, 4);
            });

            mockAtoms.forEach((atom, index) => {
                const position = new THREE.Vector3(atom.x, atom.y, atom.z);
                createAtom(atom.element, position, index, geometries);
                
                atoms.push({
                    element: atom.element,
                    position: position,
                    index: index
                });
            });

            updateAtomInfo();
            fitCameraToMolecule();
            
            console.log('✅ 简化分子创建完成');
        }

        function createAtom(element, position, index, geometries) {
            const color = atomColors[element] || atomColors.default;
            const geometry = geometries[element] || geometries.default;

            // 使用基础材质提升性能
            const material = new THREE.MeshLambertMaterial({
                color: color,
                transparent: false // 关闭透明度
            });

            const atomMesh = new THREE.Mesh(geometry, material);
            atomMesh.position.copy(position);
            
            atomMesh.userData = {
                element: element,
                index: index
            };

            atomGroup.add(atomMesh);
        }

        function updateAtomInfo() {
            const elementCount = {};
            atoms.forEach(atom => {
                elementCount[atom.element] = (elementCount[atom.element] || 0) + 1;
            });
            
            document.getElementById('atom-count').textContent = atoms.length;
            document.getElementById('h-count').textContent = elementCount['H'] || 0;
            document.getElementById('c-count').textContent = elementCount['C'] || 0;
            document.getElementById('n-count').textContent = elementCount['N'] || 0;
            document.getElementById('o-count').textContent = elementCount['O'] || 0;
        }

        function fitCameraToMolecule() {
            if (atoms.length === 0) return;

            const box = new THREE.Box3();
            atomGroup.children.forEach(atom => {
                box.expandByObject(atom);
            });

            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);

            const distance = maxDim * 3;
            camera.position.set(distance, distance, distance);
            camera.lookAt(center);
            
            controls.target.copy(center);
            controls.update();
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
        }

        function resetCamera() {
            fitCameraToMolecule();
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            atomGroup.children.forEach(atom => {
                atom.material.wireframe = wireframeMode;
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function init() {
            console.log('🧬 轻量版分子模拟系统启动...');
            
            initScene();
            
            setTimeout(() => {
                createMockMolecule();
                hideLoading();
            }, 500);
            
            animate();
            
            window.addEventListener('resize', onWindowResize, false);
            
            console.log('✅ 轻量版系统初始化完成');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>