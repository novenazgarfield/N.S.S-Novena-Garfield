import React, { useState, useRef, useEffect } from 'react';
import { useMusicPlayer } from '../hooks/useMusicPlayer';
import MusicControls from './MusicControls';
import PlaylistView from './PlaylistView';

const MusicPlayer = ({ onAnimationChange }) => {
  const {
    currentTrack,
    playlist,
    isPlaying,
    currentTime,
    duration,
    volume,
    play,
    pause,
    next,
    previous,
    setVolume,
    seek,
    loadPlaylist
  } = useMusicPlayer();

  const [showPlaylist, setShowPlaylist] = useState(false);

  // å½“æ’­æ”¾çŠ¶æ€æ”¹å˜æ—¶ï¼Œé€šçŸ¥æ¡Œå® åˆ‡æ¢åŠ¨ç”»
  useEffect(() => {
    if (onAnimationChange) {
      onAnimationChange(isPlaying ? 'listening' : 'idle');
    }
  }, [isPlaying, onAnimationChange]);

  return (
    <div className="music-player">
      <div className="music-player-header">
        <h3>ğŸµ éŸ³ä¹æ’­æ”¾å™¨</h3>
        <button 
          className="playlist-toggle"
          onClick={() => setShowPlaylist(!showPlaylist)}
        >
          ğŸ“‹
        </button>
      </div>

      {currentTrack && (
        <div className="current-track-info">
          <div className="track-title">{currentTrack.title}</div>
          <div className="track-artist">{currentTrack.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</div>
        </div>
      )}

      <MusicControls
        isPlaying={isPlaying}
        currentTime={currentTime}
        duration={duration}
        volume={volume}
        onPlay={play}
        onPause={pause}
        onNext={next}
        onPrevious={previous}
        onVolumeChange={setVolume}
        onSeek={seek}
      />

      {showPlaylist && (
        <PlaylistView
          playlist={playlist}
          currentTrack={currentTrack}
          onTrackSelect={(track) => {
            // æ’­æ”¾é€‰ä¸­çš„éŸ³ä¹
            play(track);
          }}
          onClose={() => setShowPlaylist(false)}
        />
      )}

      <div className="music-actions">
        <button onClick={loadPlaylist}>
          ğŸ”„ æ‰«ææœ¬åœ°éŸ³ä¹
        </button>
      </div>
    </div>
  );
};

export default MusicPlayer;