# NEXUS AI 隧道管理脚本使用说明

## 📋 脚本概览

本项目提供了三个自动化脚本来管理 NEXUS AI 系统的隧道连接和服务启动：

### 1. `start_tunnels.sh` - 完整启动脚本
**功能**: 完全自动化的系统启动脚本
- 🛑 停止所有现有服务
- 🚀 启动新的 Cloudflare 隧道
- 🔧 自动更新前端配置
- ⚡ 启动所有必要服务
- 🔍 执行健康检查
- 📊 显示完整状态报告

### 2. `quick_start.sh` - 快速启动脚本
**功能**: 简化的快速启动入口
- 🎯 一键启动所有服务
- 📱 适合日常使用

### 3. `check_status.sh` - 状态检查脚本
**功能**: 检查系统运行状态
- 📊 显示所有服务状态
- 🌐 测试网络连接
- 💡 提供操作建议

## 🚀 使用方法

### 启动系统
```bash
# 方法1: 使用完整启动脚本
cd /workspace/N.S.S-Novena-Garfield
./start_tunnels.sh

# 方法2: 使用快速启动脚本
./quick_start.sh
```

### 检查状态
```bash
./check_status.sh
```

## 🔄 每次变化的内容

### 自动处理的变化项：
- ✅ **Cloudflare 隧道 URL**: 每次启动自动生成新域名
- ✅ **前端配置更新**: 自动替换 API 地址
- ✅ **服务重启**: 自动停止旧服务并启动新服务
- ✅ **健康检查**: 自动验证所有服务正常运行

### 不变的内容：
- 🔒 **本地端口**: 前端 52943, API 5000
- 🔒 **服务启动命令**: 标准化的启动流程
- 🔒 **基本配置结构**: 核心配置保持不变

## 📁 生成的文件

脚本运行时会创建以下临时文件：

```
/tmp/
├── api_tunnel.log              # API隧道日志
├── frontend_tunnel.log         # 前端隧道日志
├── current_api_url.txt         # 当前API地址
├── current_frontend_url.txt    # 当前前端地址
└── nexus_current_config.txt    # 当前配置信息
```

## 🎯 典型使用场景

### 场景1: 首次启动
```bash
./start_tunnels.sh
```
脚本会完成所有初始化工作。

### 场景2: 日常重启
```bash
./quick_start.sh
```
快速重启所有服务。

### 场景3: 检查问题
```bash
./check_status.sh
```
查看系统状态，获取故障排除建议。

### 场景4: 隧道连接失效
当遇到 "Failed to fetch" 错误时：
```bash
./start_tunnels.sh
```
脚本会自动创建新隧道并更新所有配置。

## 🔧 脚本特性

### 智能错误处理
- 🛡️ 自动检测并停止冲突服务
- ⏱️ 智能等待服务启动完成
- 🔄 自动重试机制
- 📝 详细的错误日志

### 配置自动更新
- 🎯 精确替换前端配置中的 API 地址
- 💾 自动备份原配置文件
- 🔗 支持多个备用 URL

### 健康检查
- 🏥 API 服务健康检查
- 🌐 网络连接测试
- 📊 服务状态监控

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 脚本权限错误
```bash
chmod +x *.sh
```

#### 2. 隧道启动失败
- 检查网络连接
- 确认 cloudflared 文件存在
- 重新运行脚本

#### 3. 服务启动超时
- 检查端口是否被占用
- 查看日志文件排查问题
- 手动停止冲突进程

#### 4. 配置更新失败
- 检查文件权限
- 确认备份文件存在
- 手动恢复配置

## 📊 输出示例

### 成功启动输出：
```
🚀 === NEXUS AI 隧道启动脚本 === 🚀

[13:45:12] 停止现有服务...
✅ 现有服务已停止

[13:45:15] 启动RAG API隧道...
✅ API隧道已启动: https://example-api.trycloudflare.com

[13:45:25] 启动前端隧道...
✅ 前端隧道已启动: https://example-frontend.trycloudflare.com

[13:45:28] 更新前端配置...
✅ 前端配置已更新

[13:45:30] 启动RAG API服务...
✅ RAG API服务已启动

[13:45:35] 启动前端服务...
✅ 前端服务已启动

[13:45:40] 执行健康检查...
✅ API服务健康检查通过
✅ 前端服务健康检查通过

🎉 === 启动完成！=== 🎉

📱 前端界面: https://example-frontend.trycloudflare.com
🤖 RAG API: https://example-api.trycloudflare.com

✅ 所有服务已启动并运行正常
```

## 💡 最佳实践

1. **定期重启**: 建议每天重启一次隧道服务
2. **状态监控**: 使用 `check_status.sh` 定期检查系统状态
3. **日志查看**: 出现问题时查看 `/tmp/` 下的日志文件
4. **备份恢复**: 配置文件会自动备份，必要时可手动恢复

## 🎉 总结

这套脚本完全自动化了 NEXUS AI 系统的隧道管理，解决了每次手动配置的繁琐问题。只需要运行一个命令，就能获得完全配置好的系统环境！